<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÉ‚Äç‚ôÇÔ∏è Drill Tracker - Complete Application</title>
    
    <!-- External Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ===================================================
         AUTHENTICATION PAGE (LOGIN/REGISTER)
         =================================================== -->
    <div id="authPage" class="page active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>üèÉ‚Äç‚ôÇÔ∏è Drill Tracker</h1>
                    <p>Track your drills, achieve your goals</p>
                </div>
                
                <div class="tab-container">
                    <button class="tab-btn active" onclick="showLogin()">Login</button>
                    <button class="tab-btn" onclick="showRegister()">Register</button>
                </div>
                
                <!-- Login Form -->
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" name="password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn-primary">üöÄ Sign In</button>
                </form>
                
                <!-- Register Form -->
                <form id="registerForm" class="auth-form hidden">
                    <div class="form-group">
                        <label for="registerName">Full Name</label>
                        <input type="text" id="registerName" name="name" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email Address</label>
                        <input type="email" id="registerEmail" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="registerOrganization">Organization</label>
                        <input type="text" id="registerOrganization" name="organization" required placeholder="Enter your organization">
                    </div>
                    <div class="form-group">
                        <label for="registerTeamId">Team ID</label>
                        <input type="text" id="registerTeamId" name="teamId" placeholder="Enter team ID (optional)">
                    </div>
                    <div class="form-group">
                        <label for="registerRole">Role</label>
                        <select id="registerRole" name="role">
                            <option value="member">Member</option>
                            <option value="leader">Team Leader</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" name="password" required placeholder="Choose a strong password">
                    </div>
                    <button type="submit" class="btn-primary">üéØ Create Account</button>
                </form>
                
                <div class="auth-footer">
                    <p>New to Drill Tracker? <a href="#" onclick="showRegister()">Create an account</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================================
         DASHBOARD PAGE
         =================================================== -->
    <div id="dashboardPage" class="page">
        <div class="dashboard-layout">
            <!-- Organizations Sidebar -->
            <div class="organizations-sidebar">
                <div class="sidebar-header">
                    <h3>üè¢ Organizations</h3>
                    <button onclick="showAddOrganizationModal()" class="btn-small">+ Add</button>
                </div>
                <div id="organizationsList" class="organizations-list">
                    <!-- Organizations will be loaded here -->
                </div>
            </div>

            <!-- Main Dashboard Content -->
            <div class="main-content">
                <!-- Header Section -->
                <div class="header">
                    <h1>üèÉ‚Äç‚ôÇÔ∏è Drill Tracker Dashboard</h1>
                    <div class="user-info">
                        <span class="user-name">Welcome back, <span id="userName">User</span>!</span>
                        <button onclick="logout()" class="btn-secondary">Logout</button>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Drills</h3>
                        <div class="stat-number" id="totalDrills">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed</h3>
                        <div class="stat-number" id="completedDrills">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Success Rate</h3>
                        <div class="stat-number" id="successRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Week</h3>
                        <div class="stat-number" id="weeklyDrills">0</div>
                    </div>
                </div>
                
                <!-- Controls Section -->
                <div class="controls">
                    <button onclick="showAddDrillModal()" class="btn-primary">‚ú® Add New Drill</button>
                    <button onclick="showOrganizationModal()" class="btn-primary">üè¢ Manage Organizations</button>
                    <button onclick="generateSchedule()" class="btn-primary">üéØ Generate Event Schedule</button>
                    <div class="date-inputs">
                        <input type="date" id="filterStartDate" placeholder="Start Date">
                        <input type="date" id="filterEndDate" placeholder="End Date">
                        <button onclick="filterDrills()" class="btn-primary">üîç Filter</button>
                    </div>
                </div>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="statusFilter">Status:</label>
                        <select id="statusFilter" onchange="applyFilters()">
                            <option value="">All Statuses</option>
                            <option value="completed">Completed</option>
                            <option value="incomplete">Incomplete</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="missed">Missed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="teamFilter">View:</label>
                        <select id="teamFilter" onchange="applyFilters()">
                            <option value="team">My Team</option>
                            <option value="my">My Drills Only</option>
                            <option value="organization">Organization</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="visibilityFilter">Visibility:</label>
                        <select id="visibilityFilter" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="private">Private</option>
                            <option value="team">Team</option>
                            <option value="organization">Organization</option>
                        </select>
                    </div>
                    <button onclick="clearFilters()" class="btn-secondary">Clear Filters</button>
                </div>
                
                <!-- Main Content Layout -->
                <div class="main-layout">
                    <!-- Center Panel: Calendar -->
                    <div class="center-panel">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="nav-btn" onclick="previousMonth()">‚óÄ</button>
                                <h2 id="currentMonth">Loading...</h2>
                                <button class="nav-btn" onclick="nextMonth()">‚ñ∂</button>
                            </div>
                            <div id="calendar" class="calendar"></div>
                        </div>
                    </div>

                    <!-- Right Panel: Drills List -->
                    <div class="right-panel">
                        <div class="drills-sidebar">
                            <div class="sidebar-header">
                                <h3>üìã Drill Schedule</h3>
                            </div>
                            <div id="drillsList" class="drills-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal for drill details -->
        <div id="drillModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDrillModal()">&times;</span>
                <h2 id="modalDrillName">Drill Details</h2>
                <p><strong>üìÖ Scheduled Date:</strong> <span id="modalScheduledDate"></span></p>
                <p><strong>üìä Status:</strong> <span id="modalStatus"></span></p>
                <p><strong>üìù Description:</strong> <span id="modalDescription"></span></p>
                <div id="modalActions">
                    <button onclick="markCompleted()" class="btn-success">‚úÖ Mark Completed</button>
                    <button onclick="showReschedule()" class="btn-secondary">üìÖ Reschedule</button>
                    <button onclick="deleteDrill()" class="btn-danger">üóëÔ∏è Delete Drill</button>
                </div>
                <div id="rescheduleSection" class="hidden">
                    <label for="newScheduleDate">New Schedule Date</label>
                    <input type="datetime-local" id="newScheduleDate" placeholder="Select new date and time">
                    <button onclick="reschedule()" class="btn-primary">üîÑ Update Schedule</button>
                </div>
            </div>
        </div>

        <!-- Modal for adding new drill -->
        <div id="addDrillModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddDrillModal()">&times;</span>
                <h2>‚ú® Add New Drill</h2>
                <form id="addDrillForm">
                    <div class="form-group">
                        <label for="newDrillName">Drill Name *</label>
                        <input type="text" id="newDrillName" name="name" required placeholder="Enter drill name...">
                    </div>
                    <div class="form-group">
                        <label for="newDrillDate">Scheduled Date & Time *</label>
                        <input type="datetime-local" id="newDrillDate" name="scheduledDate" required>
                    </div>
                    <div class="form-group">
                        <label for="newDrillDescription">Description</label>
                        <textarea id="newDrillDescription" name="description" placeholder="Enter drill description (optional)..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newDrillVisibility">Visibility</label>
                        <select id="newDrillVisibility" name="visibility">
                            <option value="team">Team</option>
                            <option value="private">Private</option>
                            <option value="organization">Organization</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddDrillModal()" class="btn-secondary">‚ùå Cancel</button>
                        <button type="submit" class="btn-primary">üöÄ Add Drill</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for organization management -->
        <div id="organizationModal" class="modal">
            <div class="modal-content large-modal">
                <span class="close" onclick="closeOrganizationModal()">&times;</span>
                <h2>üè¢ Organization Management</h2>
                
                <div class="org-tabs">
                    <button class="tab-btn active" onclick="showOrgTab('create')">Create Organization</button>
                    <button class="tab-btn" onclick="showOrgTab('schedule')">Schedule Drills</button>
                </div>

                <!-- Create Organization Tab -->
                <div id="createOrgTab" class="org-tab-content">
                    <form id="createOrgForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="orgCompanyId">Company ID *</label>
                                <input type="text" id="orgCompanyId" name="companyId" required placeholder="Enter company ID">
                            </div>
                            <div class="form-group">
                                <label for="orgName">Organization Name *</label>
                                <input type="text" id="orgName" name="name" required placeholder="Enter organization name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="orgIndustry">Industry</label>
                                <input type="text" id="orgIndustry" name="industry" placeholder="e.g., Healthcare, Technology">
                            </div>
                            <div class="form-group">
                                <label for="orgLocation">Location</label>
                                <input type="text" id="orgLocation" name="location" placeholder="City, Country">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="orgDescription">Description</label>
                            <textarea id="orgDescription" name="description" placeholder="Brief description of the organization"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="plannedDrillsPerYear">Planned Drills Per Year</label>
                                <input type="number" id="plannedDrillsPerYear" name="plannedDrillsPerYear" value="12" min="1" max="52">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="closeOrganizationModal()" class="btn-secondary">‚ùå Cancel</button>
                            <button type="submit" class="btn-primary">üè¢ Create Organization</button>
                        </div>
                    </form>
                </div>

                <!-- Schedule Drills Tab -->
                <div id="scheduleDrillsTab" class="org-tab-content hidden">
                    <form id="scheduleDrillsForm">
                        <div class="form-group">
                            <label for="scheduleOrgSelect">Select Organization *</label>
                            <select id="scheduleOrgSelect" name="organizationId" required>
                                <option value="">Choose an organization...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduleStartDate">Start Date *</label>
                                <input type="date" id="scheduleStartDate" name="startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="scheduleEndDate">End Date *</label>
                                <input type="date" id="scheduleEndDate" name="endDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="numberOfDrills">Number of Drills</label>
                            <input type="number" id="numberOfDrills" name="numberOfDrills" min="1" max="52" placeholder="Auto-filled from organization settings">
                        </div>
                        <div class="drill-preview" id="drillPreview">
                            <h4>üìÖ Drill Schedule Preview</h4>
                            <div id="previewList"></div>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="previewDrillSchedule()" class="btn-secondary">üëÅÔ∏è Preview Schedule</button>
                            <button type="submit" class="btn-primary">üìÖ Confirm & Schedule Drills</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal for adding new organization (simplified) -->
        <div id="addOrganizationModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddOrganizationModal()">&times;</span>
                <h2>üè¢ Add New Organization</h2>
                <form id="addOrgForm">
                    <div class="form-group">
                        <label for="newOrgCompanyId">Company ID *</label>
                        <input type="text" id="newOrgCompanyId" name="companyId" required placeholder="Enter unique company ID">
                    </div>
                    <div class="form-group">
                        <label for="newOrgName">Organization Name *</label>
                        <input type="text" id="newOrgName" name="name" required placeholder="Enter organization name">
                    </div>
                    <div class="form-group">
                        <label for="newOrgDrillsPerYear">Planned Drills Per Year</label>
                        <input type="number" id="newOrgDrillsPerYear" name="plannedDrillsPerYear" value="12" min="1" max="52">
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddOrganizationModal()" class="btn-secondary">‚ùå Cancel</button>
                        <button type="submit" class="btn-primary">üöÄ Add Organization</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===================================================
         ERROR PAGE (404)
         =================================================== -->
    <div id="errorPage" class="page">
        <div class="error-container">
            <div class="error-code">404</div>
            <h1 class="error-message">ü§î Page Not Found</h1>
            <p class="error-description">
                Oops! The page you're looking for doesn't exist. 
                It might have been moved, deleted, or you entered the wrong URL.
            </p>
            <button onclick="navigateToPage('authPage')" class="btn-primary">
                üè† Back to Home
            </button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification hidden">
        <span id="notificationMessage"></span>
    </div>

    <!-- ===================================================
         JAVASCRIPT APPLICATION LOGIC
         =================================================== -->
    <script>
        /**
         * ===================================================
         * GLOBAL CONFIGURATION & STATE
         * ===================================================
         */
        const API_BASE = '/api';
        const currentDate = new Date();
        let drills = [];
        let currentDrillId = null;
        let currentCalendarDate = new Date();
        let currentPage = 'authPage';

        /**
         * ===================================================
         * PAGE NAVIGATION & INITIALIZATION
         * ===================================================
         */
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Drill Tracker Application...');
            
            // Check authentication status
            if (localStorage.getItem('token')) {
                navigateToPage('dashboardPage');
                initializeDashboard();
            } else {
                navigateToPage('authPage');
            }
            
            setupEventListeners();
        });

        // Navigate between pages
        function navigateToPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;
            
            console.log(`üìÑ Navigated to: ${pageId}`);
        }

        /**
         * ===================================================
         * AUTHENTICATION FUNCTIONALITY
         * ===================================================
         */
        
        // Show login form
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        }

        // Show register form
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showNotification('Login successful! Welcome back.', 'success');
                    navigateToPage('dashboardPage');
                    await initializeDashboard();
                } else {
                    showNotification(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const organization = document.getElementById('registerOrganization').value;
            const teamId = document.getElementById('registerTeamId').value;
            const role = document.getElementById('registerRole').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, organization, teamId, role, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showNotification('Registration successful! Welcome to Drill Tracker.', 'success');
                    navigateToPage('dashboardPage');
                    await initializeDashboard();
                } else {
                    showNotification(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Logout user
        function logout() {
            localStorage.removeItem('token');
            showNotification('You have been logged out.', 'success');
            navigateToPage('authPage');
            
            // Reset forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        /**
         * ===================================================
         * DASHBOARD FUNCTIONALITY
         * ===================================================
         */
        
        // Initialize dashboard
        async function initializeDashboard() {
            showLoading();
            
            try {
                // Load user data first, then drills and organizations
                await loadUserData();
                await loadDrills();
                await loadOrganizations();
                
                // Create test organization if none exist
                if (organizations.length === 0) {
                    console.log('üìã No organizations found, creating test organization...');
                    await createTestOrganization();
                }
                
                // Update stats after drills are loaded
                updateUserStats({ name: document.getElementById('userName').textContent });
                
                renderCalendar();
                renderDrillsList();
                setDefaultDates();
                
                hideLoading();
                console.log('‚úÖ Dashboard initialized successfully');
                console.log(`üìä Loaded ${drills.length} drills and ${organizations.length} organizations`);
            } catch (error) {
                hideLoading();
                console.error('‚ùå Dashboard initialization failed:', error);
                showNotification('Failed to load dashboard data.', 'error');
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateUserStats(data.user);
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update user statistics based on actual drill data
        function updateUserStats(user) {
            const nameElement = document.getElementById('userName');
            if (nameElement) {
                nameElement.textContent = user.name || 'User';
            }
            
            // Calculate stats from actual drills data
            const totalDrills = drills.length;
            const completedDrills = drills.filter(drill => drill.status === 'completed').length;
            const currentWeek = getCurrentWeekDrills();
            
            const totalElement = document.getElementById('totalDrills');
            if (totalElement) {
                totalElement.textContent = totalDrills;
            }
            
            const completedElement = document.getElementById('completedDrills');
            if (completedElement) {
                completedElement.textContent = completedDrills;
            }
            
            const successRateElement = document.getElementById('successRate');
            if (successRateElement) {
                const rate = totalDrills > 0 
                    ? Math.round((completedDrills / totalDrills) * 100) 
                    : 0;
                successRateElement.textContent = `${rate}%`;
            }
            
            const weeklyElement = document.getElementById('weeklyDrills');
            if (weeklyElement) {
                weeklyElement.textContent = currentWeek;
            }
        }

        // Get drills for current week
        function getCurrentWeekDrills() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            
            return drills.filter(drill => {
                const drillDate = new Date(drill.scheduledDate);
                return drillDate >= startOfWeek && drillDate <= endOfWeek;
            }).length;
        }

        // Load drills data
        async function loadDrills() {
            try {
                console.log('üìã Loading drills...');
                const response = await fetch(`${API_BASE}/drills`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    drills = await response.json();
                    console.log('üìã Loaded drills:', drills.length);
                    console.log('üìã Drills data:', drills.map(d => ({ 
                        name: d.name || d.drillName, 
                        scheduledDate: d.scheduledDate, 
                        visibility: d.visibility 
                    })));
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading drills:', error);
                showNotification('Failed to load drills.', 'error');
            }
        }

        // Enhanced render calendar with clickable dates and better drill indicators
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthElement = document.getElementById('currentMonth');
            
            if (!calendar || !monthElement) return;
            
            console.log('üìÖ Rendering calendar with', drills.length, 'drills');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            monthElement.textContent = currentCalendarDate.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            calendar.innerHTML = '';
            calendar.style.display = 'grid';
            calendar.style.gridTemplateColumns = 'repeat(7, 1fr)';
            calendar.style.gap = '1px';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.style.background = '#374151';
                dayHeader.style.color = '#a5f3fc';
                dayHeader.style.borderRadius = '4px';
                calendar.appendChild(dayHeader);
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                emptyDay.style.padding = '10px';
                emptyDay.style.minHeight = '60px';
                emptyDay.style.background = '#1a1a1a';
                emptyDay.style.borderRadius = '4px';
                calendar.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.style.padding = '10px';
                dayElement.style.minHeight = '60px';
                dayElement.style.background = '#2a2a2a';
                dayElement.style.borderRadius = '4px';
                dayElement.style.cursor = 'pointer';
                dayElement.style.position = 'relative';
                dayElement.style.transition = 'all 0.3s ease';
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.textContent = day;
                dayNumber.style.fontWeight = 'bold';
                dayNumber.style.marginBottom = '5px';
                dayElement.appendChild(dayNumber);
                
                // Check if this day has drills
                const dayDate = new Date(year, month, day);
                const dayDrills = drills.filter(drill => {
                    const drillDate = new Date(drill.scheduledDate);
                    const matches = drillDate.toDateString() === dayDate.toDateString();
                    if (matches) {
                        console.log('üìÖ Found drill on', dayDate.toDateString(), ':', drill.name || drill.drillName);
                    }
                    return matches;
                });
                
                if (dayDrills.length > 0) {
                    console.log('üìÖ Day', day, 'has', dayDrills.length, 'drills');
                    dayElement.classList.add('has-drill');
                    dayElement.style.background = '#4f46e5';
                    dayElement.style.border = '2px solid #ff6b9d';
                    
                    // Add drill indicators
                    dayDrills.forEach((drill, index) => {
                        if (index < 2) { // Show max 2 drills per day visually
                            const indicator = document.createElement('div');
                            indicator.className = 'drill-indicator';
                            indicator.textContent = drill.name || drill.drillName;
                            indicator.style.fontSize = '10px';
                            indicator.style.background = '#ff6b9d';
                            indicator.style.color = 'white';
                            indicator.style.padding = '2px 4px';
                            indicator.style.borderRadius = '2px';
                            indicator.style.marginBottom = '2px';
                            indicator.style.overflow = 'hidden';
                            indicator.style.textOverflow = 'ellipsis';
                            indicator.style.whiteSpace = 'nowrap';
                            dayElement.appendChild(indicator);
                        }
                    });
                    
                    if (dayDrills.length > 2) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.textContent = `+${dayDrills.length - 2} more`;
                        moreIndicator.style.fontSize = '9px';
                        moreIndicator.style.color = '#a3a3a3';
                        dayElement.appendChild(moreIndicator);
                    }
                }
                
                // Add click handler for each day
                dayElement.addEventListener('click', () => handleDateClick(dayDate, dayDrills));
                
                // Add hover effect
                dayElement.addEventListener('mouseenter', () => {
                    dayElement.style.transform = 'scale(1.05)';
                    dayElement.style.zIndex = '10';
                });
                
                dayElement.addEventListener('mouseleave', () => {
                    dayElement.style.transform = 'scale(1)';
                    dayElement.style.zIndex = '1';
                });
                
                calendar.appendChild(dayElement);
            }
        }

        // Navigate calendar
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // Enhanced render drills list with better styling and display
        function renderDrillsList() {
            const drillsList = document.getElementById('drillsList');
            if (!drillsList) return;
            
            drillsList.innerHTML = '';
            
            console.log('üìã Rendering drills list. Total drills:', drills.length);
            
            if (drills.length === 0) {
                drillsList.innerHTML = '<p style="text-align: center; color: #a3a3a3; padding: 20px;">No drills scheduled. Add your first drill to get started!</p>';
                return;
            }
            
            // Add a header with count
            const header = document.createElement('div');
            header.style.marginBottom = '15px';
            header.style.padding = '10px';
            header.style.background = '#2a2a2a';
            header.style.borderRadius = '5px';
            header.innerHTML = `
                <span style="color: #ff6b9d; font-weight: bold;">Total Drills: ${drills.length}</span>
                <span style="color: #a3a3a3; margin-left: 20px;">Click on any drill to view details</span>
            `;
            drillsList.appendChild(header);
            
            // Sort drills by date
            const sortedDrills = [...drills].sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));
            
            sortedDrills.forEach((drill, index) => {
                const drillItem = document.createElement('div');
                drillItem.className = 'drill-item';
                drillItem.onclick = () => showDrillDetails(drill);
                
                const drillInfo = document.createElement('div');
                drillInfo.className = 'drill-info';
                
                const drillName = document.createElement('h3');
                drillName.textContent = drill.name || drill.drillName;
                
                const drillDate = document.createElement('p');
                drillDate.textContent = new Date(drill.scheduledDate).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const drillDescription = document.createElement('p');
                drillDescription.textContent = drill.description || drill.notes || 'No description';
                
                drillInfo.appendChild(drillName);
                drillInfo.appendChild(drillDate);
                drillInfo.appendChild(drillDescription);
                
                const drillStatus = document.createElement('div');
                drillStatus.className = `drill-status ${drill.status.toLowerCase()}`;
                drillStatus.textContent = drill.status.toUpperCase();
                
                drillItem.appendChild(drillInfo);
                drillItem.appendChild(drillStatus);
                
                drillsList.appendChild(drillItem);
            });
        }

        // Show drill details modal
        function showDrillDetails(drill) {
            currentDrillId = drill._id;
            
            document.getElementById('modalDrillName').textContent = drill.name || drill.drillName;
            document.getElementById('modalScheduledDate').textContent = new Date(drill.scheduledDate).toLocaleString();
            document.getElementById('modalStatus').textContent = drill.status.toUpperCase();
            document.getElementById('modalDescription').textContent = drill.description || 'No description provided';
            
            document.getElementById('drillModal').style.display = 'block';
        }

        // Close drill modal
        function closeDrillModal() {
            document.getElementById('drillModal').style.display = 'none';
            document.getElementById('rescheduleSection').classList.add('hidden');
        }

        // Show add drill modal
        function showAddDrillModal() {
            document.getElementById('addDrillModal').style.display = 'block';
        }

        // Close add drill modal
        function closeAddDrillModal() {
            document.getElementById('addDrillModal').style.display = 'none';
            document.getElementById('addDrillForm').reset();
        }

        // Handle date click - either show drills or allow adding new drill
        function handleDateClick(date, dayDrills) {
            if (dayDrills.length > 0) {
                // Show existing drills for this day
                showDayDrillsModal(date, dayDrills);
            } else {
                // Pre-fill add drill modal with selected date
                showAddDrillModalWithDate(date);
            }
        }

        // Show modal with all drills for a specific day
        function showDayDrillsModal(date, dayDrills) {
            // Create a modal to show all drills for this day
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.8)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.background = '#2a2a2a';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '500px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflowY = 'auto';
            
            const title = document.createElement('h2');
            title.textContent = `Drills for ${date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`;
            title.style.color = '#ff6b9d';
            title.style.marginBottom = '20px';
            modalContent.appendChild(title);
            
            dayDrills.forEach(drill => {
                const drillItem = document.createElement('div');
                drillItem.style.background = '#3a3a3a';
                drillItem.style.padding = '15px';
                drillItem.style.marginBottom = '10px';
                drillItem.style.borderRadius = '5px';
                drillItem.style.cursor = 'pointer';
                drillItem.style.border = '1px solid #4a4a4a';
                drillItem.style.transition = 'all 0.3s ease';
                
                drillItem.innerHTML = `
                    <h3 style="color: #a5f3fc; margin-bottom: 5px;">${drill.name || drill.drillName}</h3>
                    <p style="color: #a3a3a3; margin-bottom: 5px;">${new Date(drill.scheduledDate).toLocaleTimeString()}</p>
                    <p style="color: #e0e0e0;">${drill.description || drill.notes || 'No description'}</p>
                    <span style="background: #ff6b9d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${drill.status.toUpperCase()}</span>
                `;
                
                drillItem.addEventListener('click', () => {
                    modal.remove();
                    showDrillDetails(drill);
                });
                
                drillItem.addEventListener('mouseenter', () => {
                    drillItem.style.background = '#4a4a4a';
                });
                
                drillItem.addEventListener('mouseleave', () => {
                    drillItem.style.background = '#3a3a3a';
                });
                
                modalContent.appendChild(drillItem);
            });
            
            // Add close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '‚úï Close';
            closeButton.style.background = '#ff6b9d';
            closeButton.style.color = 'white';
            closeButton.style.border = 'none';
            closeButton.style.padding = '10px 20px';
            closeButton.style.borderRadius = '5px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.marginTop = '20px';
            closeButton.style.width = '100%';
            
            closeButton.addEventListener('click', () => modal.remove());
            modalContent.appendChild(closeButton);
            
            modal.appendChild(modalContent);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // Show add drill modal with pre-filled date
        function showAddDrillModalWithDate(date) {
            showAddDrillModal();
            
            // Pre-fill the date
            const dateInput = document.getElementById('newDrillDate');
            if (dateInput) {
                // Format date for datetime-local input
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}T10:00`; // Default to 10:00 AM
            }
        }

        // Add new drill
        async function handleAddDrill(event) {
            event.preventDefault();
            
            const name = document.getElementById('newDrillName').value;
            const scheduledDate = document.getElementById('newDrillDate').value;
            const description = document.getElementById('newDrillDescription').value;
            const visibility = document.getElementById('newDrillVisibility').value;
            
            try {
                const response = await fetch(`${API_BASE}/drills`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, scheduledDate, description, visibility })
                });
                
                if (response.ok) {
                    showNotification('Drill added successfully!', 'success');
                    closeAddDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Failed to add drill', 'error');
                }
            } catch (error) {
                console.error('Error adding drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Apply filters to drill list
        async function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;
            const visibility = document.getElementById('visibilityFilter').value;
            
            console.log('üîç Applying filters:', { status, teamFilter, visibility });
            
            try {
                let url = `${API_BASE}/drills?`;
                const params = new URLSearchParams();
                
                if (status) params.append('status', status);
                if (teamFilter) params.append('teamFilter', teamFilter);
                if (visibility) params.append('visibility', visibility);
                
                url += params.toString();
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    drills = await response.json();
                    renderCalendar();
                    renderDrillsList();
                    showNotification(`Filter applied. Showing ${drills.length} drills.`, 'success');
                } else {
                    showNotification('Failed to apply filters', 'error');
                }
            } catch (error) {
                console.error('Error applying filters:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Clear all filters
        async function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('teamFilter').value = 'team';
            document.getElementById('visibilityFilter').value = '';
            
            await loadDrills();
            renderCalendar();
            renderDrillsList();
            showNotification('Filters cleared', 'success');
        }

        // Mark drill as completed with timestamp
        async function markCompleted() {
            if (!currentDrillId) {
                showNotification('No drill selected', 'error');
                return;
            }
            
            console.log('Marking drill as completed:', currentDrillId);
            
            try {
                const response = await fetch(`${API_BASE}/drills/${currentDrillId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: 'completed',
                        completedAt: new Date().toISOString()
                    })
                });
                
                console.log('Mark completed response:', response.status);
                
                if (response.ok) {
                    const updatedDrill = await response.json();
                    console.log('Drill updated successfully:', updatedDrill);
                    showNotification('Drill marked as completed!', 'success');
                    closeDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                } else {
                    const errorData = await response.json();
                    console.error('Failed to update drill:', errorData);
                    showNotification(errorData.message || 'Failed to update drill', 'error');
                }
            } catch (error) {
                console.error('Error updating drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Delete drill
        async function deleteDrill() {
            if (!currentDrillId) {
                showNotification('No drill selected', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this drill?')) return;
            
            console.log('Deleting drill:', currentDrillId);
            
            try {
                const response = await fetch(`${API_BASE}/drills/${currentDrillId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Delete response:', response.status);
                
                if (response.ok) {
                    console.log('Drill deleted successfully');
                    showNotification('Drill deleted successfully!', 'success');
                    closeDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                } else {
                    const errorData = await response.json();
                    console.error('Failed to delete drill:', errorData);
                    showNotification(errorData.message || 'Failed to delete drill', 'error');
                }
            } catch (error) {
                console.error('Error deleting drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Show reschedule section
        function showReschedule() {
            document.getElementById('rescheduleSection').classList.remove('hidden');
        }

        // Reschedule drill
        async function reschedule() {
            if (!currentDrillId) {
                showNotification('No drill selected', 'error');
                return;
            }
            
            const newDate = document.getElementById('newScheduleDate').value;
            if (!newDate) {
                showNotification('Please select a new date and time', 'error');
                return;
            }
            
            console.log('Rescheduling drill:', currentDrillId, 'to:', newDate);
            
            try {
                const response = await fetch(`${API_BASE}/drills/${currentDrillId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ scheduledDate: newDate })
                });
                
                console.log('Reschedule response:', response.status);
                
                if (response.ok) {
                    const updatedDrill = await response.json();
                    console.log('Drill rescheduled successfully:', updatedDrill);
                    showNotification('Drill rescheduled successfully!', 'success');
                    closeDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                } else {
                    const errorData = await response.json();
                    console.error('Failed to reschedule drill:', errorData);
                    showNotification(errorData.message || 'Failed to reschedule drill', 'error');
                }
            } catch (error) {
                console.error('Error rescheduling drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Filter drills
        function filterDrills() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Please select both start and end dates', 'error');
                return;
            }
            
            // Implementation for filtering drills
            showNotification('Filter applied successfully!', 'success');
        }

        // Enhanced generate schedule function
        async function generateSchedule() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Please select start and end dates for schedule generation', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('Start date must be before end date', 'error');
                return;
            }
            
            showLoading();
            showNotification('Generating schedule...', 'success');
            
            try {
                const response = await fetch(`${API_BASE}/drills/generate-schedule`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ startDate, endDate })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const generatedCount = result.drills ? result.drills.length : 0;
                    showNotification(`Schedule generated successfully! Added ${generatedCount} new drills.`, 'success');
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to generate schedule', 'error');
                }
            } catch (error) {
                console.error('Error generating schedule:', error);
                showNotification('Network error. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const startDateInput = document.getElementById('filterStartDate');
            const endDateInput = document.getElementById('filterEndDate');
            
            if (startDateInput) {
                startDateInput.value = today.toISOString().split('T')[0];
            }
            
            if (endDateInput) {
                endDateInput.value = nextWeek.toISOString().split('T')[0];
            }
        }

        /**
         * ===================================================
         * ORGANIZATION MANAGEMENT FUNCTIONALITY
         * ===================================================
         */

        let organizations = [];
        let selectedOrganization = null;

        // Load organizations
        async function loadOrganizations() {
            try {
                const response = await fetch(`${API_BASE}/organizations`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    organizations = await response.json();
                    renderOrganizationsList();
                    loadOrganizationsForSelect(); // Also update the select dropdown
                } else {
                    console.error('Failed to load organizations');
                    showNotification('Failed to load organizations', 'error');
                }
            } catch (error) {
                console.error('Error loading organizations:', error);
                showNotification('Network error loading organizations', 'error');
            }
        }

        // Render organizations list
        function renderOrganizationsList() {
            const orgsList = document.getElementById('organizationsList');
            if (!orgsList) return;

            orgsList.innerHTML = '';

            if (organizations.length === 0) {
                orgsList.innerHTML = '<p style="text-align: center; color: #a3a3a3; padding: 20px;">No organizations found. Create your first organization!</p>';
                return;
            }

            organizations.forEach(org => {
                const orgItem = document.createElement('div');
                orgItem.className = 'org-item';
                orgItem.onclick = () => selectOrganization(org);

                orgItem.innerHTML = `
                    <div class="org-name">${org.name}</div>
                    <div class="org-details">ID: ${org.companyId}</div>
                    <div class="org-details">${org.industry || 'No industry specified'}</div>
                    <div class="org-stats">
                        <span>üìä ${org.totalDrills || 0} drills</span>
                        <span>üìÖ ${org.plannedDrillsPerYear}/year</span>
                    </div>
                `;

                orgsList.appendChild(orgItem);
            });
        }

        // Select organization
        function selectOrganization(org) {
            selectedOrganization = org;
            
            // Update UI to show selection
            document.querySelectorAll('.org-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.org-item').classList.add('selected');

            showNotification(`Selected: ${org.name}`, 'success');
        }

        // Show organization management modal
        function showOrganizationModal() {
            document.getElementById('organizationModal').style.display = 'block';
            loadOrganizationsForSelect();
        }

        // Close organization modal
        function closeOrganizationModal() {
            document.getElementById('organizationModal').style.display = 'none';
            document.getElementById('createOrgForm').reset();
            document.getElementById('scheduleDrillsForm').reset();
            document.getElementById('drillPreview').classList.add('hidden');
        }

        // Show add organization modal (simplified)
        function showAddOrganizationModal() {
            document.getElementById('addOrganizationModal').style.display = 'block';
        }

        // Close add organization modal
        function closeAddOrganizationModal() {
            document.getElementById('addOrganizationModal').style.display = 'none';
            document.getElementById('addOrgForm').reset();
        }

        // Switch between organization tabs
        function showOrgTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.org-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.getElementById('createOrgTab').classList.toggle('hidden', tabName !== 'create');
            document.getElementById('scheduleDrillsTab').classList.toggle('hidden', tabName !== 'schedule');
        }

        // Handle create organization form
        async function handleCreateOrganization(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const orgData = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`${API_BASE}/organizations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orgData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Organization created successfully!', 'success');
                    closeOrganizationModal();
                    await loadOrganizations();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to create organization', 'error');
                }
            } catch (error) {
                console.error('Error creating organization:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Handle add organization form (simplified)
        async function handleAddOrganization(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const orgData = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`${API_BASE}/organizations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orgData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Organization added successfully!', 'success');
                    closeAddOrganizationModal();
                    await loadOrganizations();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to add organization', 'error');
                }
            } catch (error) {
                console.error('Error adding organization:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Load organizations for select dropdown
        function loadOrganizationsForSelect() {
            const select = document.getElementById('scheduleOrgSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose an organization...</option>';
            
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org._id;
                option.textContent = `${org.name} (${org.companyId})`;
                option.dataset.plannedDrills = org.plannedDrillsPerYear;
                select.appendChild(option);
            });
        }

        // Handle organization select change for scheduling
        function handleOrgSelectChange() {
            const select = document.getElementById('scheduleOrgSelect');
            const numberOfDrillsInput = document.getElementById('numberOfDrills');
            
            if (select.value && numberOfDrillsInput) {
                const selectedOption = select.options[select.selectedIndex];
                const plannedDrills = selectedOption.dataset.plannedDrills;
                numberOfDrillsInput.value = plannedDrills || '';
            }
        }

        // Preview scheduled drills
        function previewScheduledDrills() {
            const orgSelect = document.getElementById('scheduleOrgSelect');
            const startDate = document.getElementById('scheduleStartDate').value;
            const endDate = document.getElementById('scheduleEndDate').value;
            const numberOfDrills = document.getElementById('numberOfDrills').value;

            if (!orgSelect.value || !startDate || !endDate || !numberOfDrills) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            const interval = Math.floor(totalDays / numberOfDrills);

            const drillTypes = [
                "Fire Drill",
                "Lockdown Drill",
                "Earthquake Drill",
                "Medical Emergency Drill",
                "Severe Weather Drill"
            ];

            const previewContainer = document.getElementById('drillPreviewList');
            previewContainer.innerHTML = '';

            for (let i = 0; i < numberOfDrills; i++) {
                const drillDate = new Date(start);
                drillDate.setDate(start.getDate() + (i * interval));
                const drillType = drillTypes[i % drillTypes.length];

                const previewItem = document.createElement('div');
                previewItem.className = 'drill-preview-item';
                previewItem.innerHTML = `
                    <span class="drill-name">${drillType}</span>
                    <span class="drill-date">${drillDate.toLocaleDateString()}</span>
                `;
                previewContainer.appendChild(previewItem);
            }

            document.getElementById('drillPreview').classList.remove('hidden');
        }

        // Handle schedule drills form
        async function handleScheduleDrills(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const scheduleData = Object.fromEntries(formData);

            console.log('üìÖ Schedule data:', scheduleData);

            if (!scheduleData.organizationId) {
                showNotification('Please select an organization', 'error');
                return;
            }

            if (!scheduleData.startDate || !scheduleData.endDate) {
                showNotification('Please select start and end dates', 'error');
                return;
            }

            if (!scheduleData.numberOfDrills || scheduleData.numberOfDrills < 1) {
                showNotification('Please enter a valid number of drills', 'error');
                return;
            }

            try {
                console.log('üìÖ Sending request to:', `${API_BASE}/organizations/${scheduleData.organizationId}/schedule-drills`);
                
                const response = await fetch(`${API_BASE}/organizations/${scheduleData.organizationId}/schedule-drills`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startDate: scheduleData.startDate,
                        endDate: scheduleData.endDate,
                        numberOfDrills: parseInt(scheduleData.numberOfDrills)
                    })
                });
                
                console.log('üìÖ Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìÖ Success result:', result);
                    showNotification(`${result.drillsGenerated} drills scheduled successfully for ${result.organization}!`, 'success');
                    closeOrganizationModal();
                    await loadDrills();
                    await loadOrganizations();
                    renderCalendar();
                    renderDrillsList();
                } else {
                    const error = await response.json();
                    console.error('üìÖ Error response:', error);
                    showNotification(error.message || 'Failed to schedule drills', 'error');
                }
            } catch (error) {
                console.error('Error scheduling drills:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Create a test organization for demo purposes
        async function createTestOrganization() {
            try {
                console.log('üè¢ Creating test organization...');
                
                const response = await fetch(`${API_BASE}/organizations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        companyId: 'ABC-001',
                        name: 'ABC Corporation',
                        description: 'Sample organization for testing',
                        industry: 'Technology',
                        location: 'New York, NY',
                        plannedDrillsPerYear: 12,
                        drillTypes: [
                            'Fire Evacuation Drill',
                            'Earthquake Drill',
                            'Lockdown Drill',
                            'Medical Emergency Drill',
                            'Severe Weather Drill'
                        ]
                    })
                });

                console.log('üè¢ Test org creation response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Test organization created successfully:', result);
                    await loadOrganizations();
                    showNotification('Test organization created successfully!', 'success');
                } else {
                    const error = await response.json();
                    console.error('‚ùå Test organization creation failed:', error);
                    
                    // If it's a duplicate error, that's okay - just load existing organizations
                    if (error.message && error.message.includes('already exists')) {
                        console.log('üìã Organization already exists, continuing...');
                        await loadOrganizations();
                    } else {
                        showNotification(`Failed to create test organization: ${error.message}`, 'error');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error creating test organization:', error);
                showNotification('Network error creating test organization', 'error');
            }
        }

        /**
         * ===================================================
         * UTILITY FUNCTIONS
         * ===================================================
         */
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Show loading state
        function showLoading() {
            document.body.classList.add('loading');
        }

        // Hide loading state
        function hideLoading() {
            document.body.classList.remove('loading');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('addDrillForm').addEventListener('submit', handleAddDrill);
            document.getElementById('addOrgForm').addEventListener('submit', handleAddOrganization);
            document.getElementById('createOrgForm').addEventListener('submit', handleCreateOrganization);
            document.getElementById('scheduleDrillsForm').addEventListener('submit', handleScheduleDrills);
            
            // Modal close on outside click
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            console.log('‚úÖ Event listeners setup complete');
        }
    </script>
</body>
</html>
