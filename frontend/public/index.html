<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÉ‚Äç‚ôÇÔ∏è Drill Tracker - Complete Application</title>
    
    <!-- External Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ===================================================
         AUTHENTICATION PAGE (LOGIN/REGISTER)
         =================================================== -->
    <div id="authPage" class="page active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>üèÉ‚Äç‚ôÇÔ∏è Drill Tracker</h1>
                    <p>Track your drills, achieve your goals</p>
                </div>
                
                <div class="tab-container">
                    <button class="tab-btn active" onclick="showLogin()">Login</button>
                    <button class="tab-btn" onclick="showRegister()">Register</button>
                </div>
                
                <!-- Login Form -->
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" name="password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn-primary">üöÄ Sign In</button>
                </form>
                
                <!-- Register Form -->
                <form id="registerForm" class="auth-form hidden">
                    <div class="form-group">
                        <label for="registerName">Full Name</label>
                        <input type="text" id="registerName" name="name" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email Address</label>
                        <input type="email" id="registerEmail" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="registerOrganization">Organization</label>
                        <input type="text" id="registerOrganization" name="organization" placeholder="Enter your organization (optional)">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" name="password" required placeholder="Choose a strong password">
                    </div>
                    <button type="submit" class="btn-primary">üéØ Create Account</button>
                </form>
                
                <div class="auth-footer">
                    <p>New to Drill Tracker? <a href="#" onclick="showRegister()">Create an account</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================================
         DASHBOARD PAGE
         =================================================== -->
    <div id="dashboardPage" class="page">
        <div class="container">
            <!-- Header Section -->
            <div class="header">
                <h1>üèÉ‚Äç‚ôÇÔ∏è Drill Tracker Dashboard</h1>
                <div class="user-info">
                    <span class="user-name">Welcome back, <span id="userName">User</span>!</span>
                    <button onclick="logout()" class="btn-secondary">Logout</button>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Total Drills</h3>
                    <div class="stat-number" id="totalDrills">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="stat-number" id="completedDrills">0</div>
                </div>
                <div class="stat-card">
                    <h3>Success Rate</h3>
                    <div class="stat-number" id="successRate">0%</div>
                </div>
                <div class="stat-card">
                    <h3>This Week</h3>
                    <div class="stat-number" id="weeklyDrills">0</div>
                </div>
            </div>
            
            <!-- Controls Section -->
            <div class="controls">
                <button onclick="showAddDrillModal()" class="btn-primary">‚ú® Add New Drill</button>
                <button onclick="generateSchedule()" class="btn-primary">üéØ Generate Event Schedule</button>
                <div class="date-inputs">
                    <input type="date" id="filterStartDate" placeholder="Start Date">
                    <input type="date" id="filterEndDate" placeholder="End Date">
                    <button onclick="filterDrills()" class="btn-primary">üîç Filter</button>
                </div>
            </div>
            
            <!-- Main Content Area with Three-Column Layout -->
            <div class="main-content-grid">
                <!-- Left Column: Drills List -->
                <div class="left-panel">
                    <div class="drills-container">
                        <h2>üìã Drill Schedule</h2>
                        <div id="drillsList" class="drills-list"></div>
                    </div>
                </div>
                
                <!-- Center Column: Calendar -->
                <div class="center-panel">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="nav-btn" onclick="previousMonth()">‚óÄ</button>
                            <h2 id="currentMonth">Loading...</h2>
                            <button class="nav-btn" onclick="nextMonth()">‚ñ∂</button>
                        </div>
                        <div id="calendar" class="calendar"></div>
                    </div>
                </div>
                
                <!-- Right Column: Task Drill Container -->
                <div class="right-panel">
                    <div class="task-drill-container">
                        <h2>üéØ Quick Actions</h2>
                        
                        <!-- Quick Add Drill Form -->
                        <div class="quick-add-section">
                            <h3>‚ûï Quick Add Drill</h3>
                            <form id="quickAddForm" class="quick-form">
                                <input type="text" id="quickDrillName" placeholder="Drill name..." required>
                                <input type="datetime-local" id="quickDrillDate" title="Select drill date and time" required>
                                <textarea id="quickDrillDescription" placeholder="Description (optional)..." rows="2"></textarea>
                                <button type="submit" class="btn-quick">Add Drill</button>
                            </form>
                        </div>
                        
                        <!-- Today's Drills -->
                        <div class="today-drills-section">
                            <h3>ÔøΩ Today's Drills</h3>
                            <div id="todayDrillsList" class="today-drills-list">
                                <!-- Today's drills will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Upcoming Drills -->
                        <div class="upcoming-drills-section">
                            <h3>‚è∞ Next 7 Days</h3>
                            <div id="upcomingDrillsList" class="upcoming-drills-list">
                                <!-- Upcoming drills will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="quick-stats-section">
                            <h3>üìä Quick Stats</h3>
                            <div class="mini-stats">
                                <div class="mini-stat">
                                    <span class="stat-label">This Month:</span>
                                    <span class="stat-value" id="monthlyDrills">0</span>
                                </div>
                                <div class="mini-stat">
                                    <span class="stat-label">Completed:</span>
                                    <span class="stat-value" id="monthlyCompleted">0</span>
                                </div>
                                <div class="mini-stat">
                                    <span class="stat-label">Pending:</span>
                                    <span class="stat-value" id="monthlyPending">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal for drill details -->
        <div id="drillModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDrillModal()">&times;</span>
                <h2 id="modalDrillName">Drill Details</h2>
                <p><strong>üìÖ Scheduled Date:</strong> <span id="modalScheduledDate"></span></p>
                <p><strong>üìä Status:</strong> <span id="modalStatus"></span></p>
                <p><strong>üìù Description:</strong> <span id="modalDescription"></span></p>
                <div id="modalActions">
                    <button onclick="markCompleted()" class="btn-success">‚úÖ Mark Completed</button>
                    <button onclick="showReschedule()" class="btn-secondary">üìÖ Reschedule</button>
                    <button onclick="deleteDrill()" class="btn-danger">üóëÔ∏è Delete Drill</button>
                </div>
                <div id="rescheduleSection" class="hidden">
                    <label for="newScheduleDate">New Schedule Date</label>
                    <input type="datetime-local" id="newScheduleDate" placeholder="Select new date and time">
                    <button onclick="reschedule()" class="btn-primary">üîÑ Update Schedule</button>
                </div>
            </div>
        </div>

        <!-- Modal for adding new drill -->
        <div id="addDrillModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddDrillModal()">&times;</span>
                <h2>‚ú® Add New Drill</h2>
                <form id="addDrillForm">
                    <div class="form-group">
                        <label for="newDrillName">Drill Name *</label>
                        <input type="text" id="newDrillName" name="name" required placeholder="Enter drill name...">
                    </div>
                    <div class="form-group">
                        <label for="newDrillDate">Scheduled Date & Time *</label>
                        <input type="datetime-local" id="newDrillDate" name="scheduledDate" required>
                    </div>
                    <div class="form-group">
                        <label for="newDrillDescription">Description</label>
                        <textarea id="newDrillDescription" name="description" placeholder="Enter drill description (optional)..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddDrillModal()" class="btn-secondary">‚ùå Cancel</button>
                        <button type="submit" class="btn-primary">üöÄ Add Drill</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===================================================
         ERROR PAGE (404)
         =================================================== -->
    <div id="errorPage" class="page">
        <div class="error-container">
            <div class="error-code">404</div>
            <h1 class="error-message">ü§î Page Not Found</h1>
            <p class="error-description">
                Oops! The page you're looking for doesn't exist. 
                It might have been moved, deleted, or you entered the wrong URL.
            </p>
            <button onclick="navigateToPage('authPage')" class="btn-primary">
                üè† Back to Home
            </button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification hidden">
        <span id="notificationMessage"></span>
    </div>

    <!-- ===================================================
         JAVASCRIPT APPLICATION LOGIC
         =================================================== -->
    <script>
        /**
         * ===================================================
         * GLOBAL CONFIGURATION & STATE
         * ===================================================
         */
        const API_BASE = '/api';
        const currentDate = new Date();
        let drills = [];
        let currentDrillId = null;
        let currentCalendarDate = new Date();
        let currentPage = 'authPage';

        /**
         * ===================================================
         * PAGE NAVIGATION & INITIALIZATION
         * ===================================================
         */
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Drill Tracker Application...');
            
            // Check authentication status
            if (localStorage.getItem('token')) {
                navigateToPage('dashboardPage');
                initializeDashboard();
            } else {
                navigateToPage('authPage');
            }
            
            setupEventListeners();
        });

        // Navigate between pages
        function navigateToPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;
            
            console.log(`üìÑ Navigated to: ${pageId}`);
        }

        /**
         * ===================================================
         * AUTHENTICATION FUNCTIONALITY
         * ===================================================
         */
        
        // Show login form
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        }

        // Show register form
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showNotification('Login successful! Welcome back.', 'success');
                    navigateToPage('dashboardPage');
                    await initializeDashboard();
                } else {
                    showNotification(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const organization = document.getElementById('registerOrganization').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, organization, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showNotification('Registration successful! Welcome to Drill Tracker.', 'success');
                    navigateToPage('dashboardPage');
                    await initializeDashboard();
                } else {
                    showNotification(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Logout user
        function logout() {
            localStorage.removeItem('token');
            showNotification('You have been logged out.', 'success');
            navigateToPage('authPage');
            
            // Reset forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        /**
         * ===================================================
         * DASHBOARD FUNCTIONALITY
         * ===================================================
         */
        
        // Initialize dashboard
        async function initializeDashboard() {
            showLoading();
            
            try {
                // Load user data first, then drills
                await loadUserData();
                await loadDrills();
                
                // Update stats after drills are loaded
                updateUserStats({ name: document.getElementById('userName').textContent });
                
                renderCalendar();
                renderDrillsList();
                renderTodayDrills();
                renderUpcomingDrills();
                updateQuickStats();
                setDefaultDates();
                
                hideLoading();
                console.log('‚úÖ Dashboard initialized successfully');
                console.log(`üìä Loaded ${drills.length} drills`);
            } catch (error) {
                hideLoading();
                console.error('‚ùå Dashboard initialization failed:', error);
                showNotification('Failed to load dashboard data.', 'error');
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateUserStats(data.user);
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update user statistics based on actual drill data
        function updateUserStats(user) {
            const nameElement = document.getElementById('userName');
            if (nameElement) {
                nameElement.textContent = user.name || 'User';
            }
            
            // Calculate stats from actual drills data
            const totalDrills = drills.length;
            const completedDrills = drills.filter(drill => drill.status === 'completed').length;
            const currentWeek = getCurrentWeekDrills();
            
            const totalElement = document.getElementById('totalDrills');
            if (totalElement) {
                totalElement.textContent = totalDrills;
            }
            
            const completedElement = document.getElementById('completedDrills');
            if (completedElement) {
                completedElement.textContent = completedDrills;
            }
            
            const successRateElement = document.getElementById('successRate');
            if (successRateElement) {
                const rate = totalDrills > 0 
                    ? Math.round((completedDrills / totalDrills) * 100) 
                    : 0;
                successRateElement.textContent = `${rate}%`;
            }
            
            const weeklyElement = document.getElementById('weeklyDrills');
            if (weeklyElement) {
                weeklyElement.textContent = currentWeek;
            }
        }

        // Get drills for current week
        function getCurrentWeekDrills() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            
            return drills.filter(drill => {
                const drillDate = new Date(drill.scheduledDate);
                return drillDate >= startOfWeek && drillDate <= endOfWeek;
            }).length;
        }

        // Load drills data
        async function loadDrills() {
            try {
                const response = await fetch(`${API_BASE}/drills`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    drills = await response.json();
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading drills:', error);
                showNotification('Failed to load drills.', 'error');
            }
        }

        // Enhanced render calendar with clickable dates and better drill indicators
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthElement = document.getElementById('currentMonth');
            
            if (!calendar || !monthElement) return;
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            monthElement.textContent = currentCalendarDate.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            calendar.innerHTML = '';
            calendar.style.display = 'grid';
            calendar.style.gridTemplateColumns = 'repeat(7, 1fr)';
            calendar.style.gap = '1px';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.style.background = '#374151';
                dayHeader.style.color = '#a5f3fc';
                dayHeader.style.borderRadius = '4px';
                calendar.appendChild(dayHeader);
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                emptyDay.style.padding = '10px';
                emptyDay.style.minHeight = '60px';
                emptyDay.style.background = '#1a1a1a';
                emptyDay.style.borderRadius = '4px';
                calendar.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.style.padding = '10px';
                dayElement.style.minHeight = '60px';
                dayElement.style.background = '#2a2a2a';
                dayElement.style.borderRadius = '4px';
                dayElement.style.cursor = 'pointer';
                dayElement.style.position = 'relative';
                dayElement.style.transition = 'all 0.3s ease';
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.textContent = day;
                dayNumber.style.fontWeight = 'bold';
                dayNumber.style.marginBottom = '5px';
                dayElement.appendChild(dayNumber);
                
                // Check if this day has drills
                const dayDate = new Date(year, month, day);
                const dayDrills = drills.filter(drill => {
                    const drillDate = new Date(drill.scheduledDate);
                    return drillDate.toDateString() === dayDate.toDateString();
                });
                
                if (dayDrills.length > 0) {
                    dayElement.classList.add('has-drill');
                    dayElement.style.background = '#4f46e5';
                    dayElement.style.border = '2px solid #ff6b9d';
                    
                    // Add drill indicators
                    dayDrills.forEach((drill, index) => {
                        if (index < 2) { // Show max 2 drills per day visually
                            const indicator = document.createElement('div');
                            indicator.className = 'drill-indicator';
                            indicator.textContent = drill.name || drill.drillName;
                            indicator.style.fontSize = '10px';
                            indicator.style.background = '#ff6b9d';
                            indicator.style.color = 'white';
                            indicator.style.padding = '2px 4px';
                            indicator.style.borderRadius = '2px';
                            indicator.style.marginBottom = '2px';
                            indicator.style.overflow = 'hidden';
                            indicator.style.textOverflow = 'ellipsis';
                            indicator.style.whiteSpace = 'nowrap';
                            dayElement.appendChild(indicator);
                        }
                    });
                    
                    if (dayDrills.length > 2) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.textContent = `+${dayDrills.length - 2} more`;
                        moreIndicator.style.fontSize = '9px';
                        moreIndicator.style.color = '#a3a3a3';
                        dayElement.appendChild(moreIndicator);
                    }
                }
                
                // Add click handler for each day
                dayElement.addEventListener('click', () => handleDateClick(dayDate, dayDrills));
                
                // Add hover effect
                dayElement.addEventListener('mouseenter', () => {
                    dayElement.style.transform = 'scale(1.05)';
                    dayElement.style.zIndex = '10';
                });
                
                dayElement.addEventListener('mouseleave', () => {
                    dayElement.style.transform = 'scale(1)';
                    dayElement.style.zIndex = '1';
                });
                
                calendar.appendChild(dayElement);
            }
        }

        // Navigate calendar
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // Enhanced render drills list for left panel with compact styling
        function renderDrillsList() {
            const drillsList = document.getElementById('drillsList');
            if (!drillsList) return;
            
            drillsList.innerHTML = '';
            
            console.log('üìã Rendering drills list. Total drills:', drills.length);
            
            if (drills.length === 0) {
                drillsList.innerHTML = '<p style="text-align: center; color: #a3a3a3; padding: 20px; font-size: 14px;">No drills scheduled. Add your first drill to get started!</p>';
                return;
            }
            
            // Add a header with count (compact version)
            const header = document.createElement('div');
            header.style.marginBottom = '10px';
            header.style.padding = '8px';
            header.style.background = '#2a2a2a';
            header.style.borderRadius = '5px';
            header.style.textAlign = 'center';
            header.innerHTML = `
                <span style="color: #ff6b9d; font-weight: bold; font-size: 14px;">Total: ${drills.length} drills</span>
            `;
            drillsList.appendChild(header);
            
            // Sort drills by date
            const sortedDrills = [...drills].sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));
            
            sortedDrills.forEach((drill, index) => {
                const drillItem = document.createElement('div');
                drillItem.className = 'drill-item';
                drillItem.style.background = '#2a2a2a';
                drillItem.style.border = '1px solid #4a4a4a';
                drillItem.style.borderRadius = '6px';
                drillItem.style.padding = '12px';
                drillItem.style.marginBottom = '8px';
                drillItem.style.cursor = 'pointer';
                drillItem.style.transition = 'all 0.3s ease';
                
                drillItem.addEventListener('mouseenter', () => {
                    drillItem.style.background = '#3a3a3a';
                    drillItem.style.borderColor = '#ff6b9d';
                });
                
                drillItem.addEventListener('mouseleave', () => {
                    drillItem.style.background = '#2a2a2a';
                    drillItem.style.borderColor = '#4a4a4a';
                });
                
                drillItem.onclick = () => showDrillDetails(drill);
                
                const drillName = document.createElement('h4');
                drillName.textContent = drill.name || drill.drillName;
                drillName.style.color = '#a5f3fc';
                drillName.style.marginBottom = '4px';
                drillName.style.fontSize = '14px';
                drillName.style.fontWeight = '600';
                
                const drillDate = document.createElement('p');
                drillDate.textContent = new Date(drill.scheduledDate).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                drillDate.style.color = '#a3a3a3';
                drillDate.style.marginBottom = '6px';
                drillDate.style.fontSize = '12px';
                
                const drillStatus = document.createElement('span');
                drillStatus.className = `drill-status ${drill.status}`;
                drillStatus.textContent = drill.status.toUpperCase();
                drillStatus.style.padding = '2px 6px';
                drillStatus.style.borderRadius = '10px';
                drillStatus.style.fontSize = '10px';
                drillStatus.style.fontWeight = 'bold';
                
                // Color code by status
                switch (drill.status.toLowerCase()) {
                    case 'completed':
                        drillStatus.style.background = '#22c55e';
                        drillStatus.style.color = 'white';
                        break;
                    case 'scheduled':
                        drillStatus.style.background = '#3b82f6';
                        drillStatus.style.color = 'white';
                        break;
                    case 'missed':
                        drillStatus.style.background = '#ef4444';
                        drillStatus.style.color = 'white';
                        break;
                    default:
                        drillStatus.style.background = '#6b7280';
                        drillStatus.style.color = 'white';
                }
                
                drillItem.appendChild(drillName);
                drillItem.appendChild(drillDate);
                drillItem.appendChild(drillStatus);
                
                drillsList.appendChild(drillItem);
            });
        }

        // Render today's drills in the right panel
        function renderTodayDrills() {
            const todayDrillsList = document.getElementById('todayDrillsList');
            if (!todayDrillsList) return;
            
            const today = new Date();
            const todayDrills = drills.filter(drill => {
                const drillDate = new Date(drill.scheduledDate);
                return drillDate.toDateString() === today.toDateString();
            });
            
            todayDrillsList.innerHTML = '';
            
            if (todayDrills.length === 0) {
                todayDrillsList.innerHTML = '<p style="color: #a3a3a3; font-size: 12px; text-align: center;">No drills scheduled for today</p>';
                return;
            }
            
            todayDrills.forEach(drill => {
                const item = createSidebarDrillItem(drill);
                todayDrillsList.appendChild(item);
            });
        }

        // Render upcoming drills in the right panel
        function renderUpcomingDrills() {
            const upcomingDrillsList = document.getElementById('upcomingDrillsList');
            if (!upcomingDrillsList) return;
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingDrills = drills.filter(drill => {
                const drillDate = new Date(drill.scheduledDate);
                return drillDate > today && drillDate <= nextWeek;
            }).sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));
            
            upcomingDrillsList.innerHTML = '';
            
            if (upcomingDrills.length === 0) {
                upcomingDrillsList.innerHTML = '<p style="color: #a3a3a3; font-size: 12px; text-align: center;">No drills in next 7 days</p>';
                return;
            }
            
            upcomingDrills.slice(0, 5).forEach(drill => { // Show max 5 upcoming drills
                const item = createSidebarDrillItem(drill);
                upcomingDrillsList.appendChild(item);
            });
        }

        // Create sidebar drill item
        function createSidebarDrillItem(drill) {
            const item = document.createElement('div');
            item.className = 'sidebar-drill-item';
            item.onclick = () => showDrillDetails(drill);
            
            const name = document.createElement('div');
            name.className = 'sidebar-drill-name';
            name.textContent = drill.name || drill.drillName;
            
            const time = document.createElement('div');
            time.className = 'sidebar-drill-time';
            time.textContent = new Date(drill.scheduledDate).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const status = document.createElement('span');
            status.className = `sidebar-drill-status ${drill.status}`;
            status.textContent = drill.status;
            
            item.appendChild(name);
            item.appendChild(time);
            item.appendChild(status);
            
            return item;
        }

        // Update quick stats in right panel
        function updateQuickStats() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyDrills = drills.filter(drill => {
                const drillDate = new Date(drill.scheduledDate);
                return drillDate.getMonth() === currentMonth && drillDate.getFullYear() === currentYear;
            });
            
            const monthlyCompleted = monthlyDrills.filter(drill => drill.status === 'completed');
            const monthlyPending = monthlyDrills.filter(drill => drill.status === 'scheduled');
            
            const monthlyDrillsEl = document.getElementById('monthlyDrills');
            const monthlyCompletedEl = document.getElementById('monthlyCompleted');
            const monthlyPendingEl = document.getElementById('monthlyPending');
            
            if (monthlyDrillsEl) monthlyDrillsEl.textContent = monthlyDrills.length;
            if (monthlyCompletedEl) monthlyCompletedEl.textContent = monthlyCompleted.length;
            if (monthlyPendingEl) monthlyPendingEl.textContent = monthlyPending.length;
        }

        // Handle quick add drill form
        async function handleQuickAddDrill(event) {
            event.preventDefault();
            
            const name = document.getElementById('quickDrillName').value;
            const scheduledDate = document.getElementById('quickDrillDate').value;
            const description = document.getElementById('quickDrillDescription').value;
            
            try {
                const response = await fetch(`${API_BASE}/drills`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, scheduledDate, description })
                });
                
                if (response.ok) {
                    showNotification('Drill added successfully!', 'success');
                    document.getElementById('quickAddForm').reset();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                    renderTodayDrills();
                    renderUpcomingDrills();
                    updateQuickStats();
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Failed to add drill', 'error');
                }
            } catch (error) {
                console.error('Error adding drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Show drill details modal
        function showDrillDetails(drill) {
            currentDrillId = drill._id;
            
            document.getElementById('modalDrillName').textContent = drill.name || drill.drillName;
            document.getElementById('modalScheduledDate').textContent = new Date(drill.scheduledDate).toLocaleString();
            document.getElementById('modalStatus').textContent = drill.status.toUpperCase();
            document.getElementById('modalDescription').textContent = drill.description || 'No description provided';
            
            document.getElementById('drillModal').style.display = 'block';
        }

        // Close drill modal
        function closeDrillModal() {
            document.getElementById('drillModal').style.display = 'none';
            document.getElementById('rescheduleSection').classList.add('hidden');
        }

        // Show add drill modal
        function showAddDrillModal() {
            document.getElementById('addDrillModal').style.display = 'block';
        }

        // Close add drill modal
        function closeAddDrillModal() {
            document.getElementById('addDrillModal').style.display = 'none';
            document.getElementById('addDrillForm').reset();
        }

        // Handle date click - either show drills or allow adding new drill
        function handleDateClick(date, dayDrills) {
            if (dayDrills.length > 0) {
                // Show existing drills for this day
                showDayDrillsModal(date, dayDrills);
            } else {
                // Pre-fill add drill modal with selected date
                showAddDrillModalWithDate(date);
            }
        }

        // Show modal with all drills for a specific day
        function showDayDrillsModal(date, dayDrills) {
            // Create a modal to show all drills for this day
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.8)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.background = '#2a2a2a';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '500px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflowY = 'auto';
            
            const title = document.createElement('h2');
            title.textContent = `Drills for ${date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`;
            title.style.color = '#ff6b9d';
            title.style.marginBottom = '20px';
            modalContent.appendChild(title);
            
            dayDrills.forEach(drill => {
                const drillItem = document.createElement('div');
                drillItem.style.background = '#3a3a3a';
                drillItem.style.padding = '15px';
                drillItem.style.marginBottom = '10px';
                drillItem.style.borderRadius = '5px';
                drillItem.style.cursor = 'pointer';
                drillItem.style.border = '1px solid #4a4a4a';
                drillItem.style.transition = 'all 0.3s ease';
                
                drillItem.innerHTML = `
                    <h3 style="color: #a5f3fc; margin-bottom: 5px;">${drill.name || drill.drillName}</h3>
                    <p style="color: #a3a3a3; margin-bottom: 5px;">${new Date(drill.scheduledDate).toLocaleTimeString()}</p>
                    <p style="color: #e0e0e0;">${drill.description || drill.notes || 'No description'}</p>
                    <span style="background: #ff6b9d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${drill.status.toUpperCase()}</span>
                `;
                
                drillItem.addEventListener('click', () => {
                    modal.remove();
                    showDrillDetails(drill);
                });
                
                drillItem.addEventListener('mouseenter', () => {
                    drillItem.style.background = '#4a4a4a';
                });
                
                drillItem.addEventListener('mouseleave', () => {
                    drillItem.style.background = '#3a3a3a';
                });
                
                modalContent.appendChild(drillItem);
            });
            
            // Add close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '‚úï Close';
            closeButton.style.background = '#ff6b9d';
            closeButton.style.color = 'white';
            closeButton.style.border = 'none';
            closeButton.style.padding = '10px 20px';
            closeButton.style.borderRadius = '5px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.marginTop = '20px';
            closeButton.style.width = '100%';
            
            closeButton.addEventListener('click', () => modal.remove());
            modalContent.appendChild(closeButton);
            
            modal.appendChild(modalContent);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // Show add drill modal with pre-filled date
        function showAddDrillModalWithDate(date) {
            showAddDrillModal();
            
            // Pre-fill the date
            const dateInput = document.getElementById('newDrillDate');
            if (dateInput) {
                // Format date for datetime-local input
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}T10:00`; // Default to 10:00 AM
            }
        }

        // Add new drill
        async function handleAddDrill(event) {
            event.preventDefault();
            
            const name = document.getElementById('newDrillName').value;
            const scheduledDate = document.getElementById('newDrillDate').value;
            const description = document.getElementById('newDrillDescription').value;
            
            try {
                const response = await fetch(`${API_BASE}/drills`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, scheduledDate, description })
                });
                
                if (response.ok) {
                    showNotification('Drill added successfully!', 'success');
                    closeAddDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                    renderTodayDrills();
                    renderUpcomingDrills();
                    updateQuickStats();
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Failed to add drill', 'error');
                }
            } catch (error) {
                console.error('Error adding drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Mark drill as completed
        async function markCompleted() {
            if (!currentDrillId) return;
            
            try {
                const response = await fetch(`${API_BASE}/drills/${currentDrillId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'completed' })
                });
                
                if (response.ok) {
                    showNotification('Drill marked as completed!', 'success');
                    closeDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                    renderTodayDrills();
                    renderUpcomingDrills();
                    updateQuickStats();
                } else {
                    showNotification('Failed to update drill', 'error');
                }
            } catch (error) {
                console.error('Error updating drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Delete drill
        async function deleteDrill() {
            if (!currentDrillId || !confirm('Are you sure you want to delete this drill?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/drills/${currentDrillId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showNotification('Drill deleted successfully!', 'success');
                    closeDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                    renderTodayDrills();
                    renderUpcomingDrills();
                    updateQuickStats();
                } else {
                    showNotification('Failed to delete drill', 'error');
                }
            } catch (error) {
                console.error('Error deleting drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Show reschedule section
        function showReschedule() {
            document.getElementById('rescheduleSection').classList.remove('hidden');
        }

        // Reschedule drill
        async function reschedule() {
            if (!currentDrillId) return;
            
            const newDate = document.getElementById('newScheduleDate').value;
            if (!newDate) {
                showNotification('Please select a new date and time', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/drills/${currentDrillId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ scheduledDate: newDate })
                });
                
                if (response.ok) {
                    showNotification('Drill rescheduled successfully!', 'success');
                    closeDrillModal();
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                    renderTodayDrills();
                    renderUpcomingDrills();
                    updateQuickStats();
                } else {
                    showNotification('Failed to reschedule drill', 'error');
                }
            } catch (error) {
                console.error('Error rescheduling drill:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Filter drills
        function filterDrills() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Please select both start and end dates', 'error');
                return;
            }
            
            // Implementation for filtering drills
            showNotification('Filter applied successfully!', 'success');
        }

        // Enhanced generate schedule function
        async function generateSchedule() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Please select start and end dates for schedule generation', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('Start date must be before end date', 'error');
                return;
            }
            
            showLoading();
            showNotification('Generating schedule...', 'success');
            
            try {
                const response = await fetch(`${API_BASE}/drills/generate-schedule`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ startDate, endDate })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const generatedCount = result.drills ? result.drills.length : 0;
                    showNotification(`Schedule generated successfully! Added ${generatedCount} new drills.`, 'success');
                    await loadDrills();
                    renderCalendar();
                    renderDrillsList();
                    renderTodayDrills();
                    renderUpcomingDrills();
                    updateQuickStats();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to generate schedule', 'error');
                }
            } catch (error) {
                console.error('Error generating schedule:', error);
                showNotification('Network error. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const startDateInput = document.getElementById('filterStartDate');
            const endDateInput = document.getElementById('filterEndDate');
            
            if (startDateInput) {
                startDateInput.value = today.toISOString().split('T')[0];
            }
            
            if (endDateInput) {
                endDateInput.value = nextWeek.toISOString().split('T')[0];
            }
        }

        /**
         * ===================================================
         * UTILITY FUNCTIONS
         * ===================================================
         */
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Show loading state
        function showLoading() {
            document.body.classList.add('loading');
        }

        // Hide loading state
        function hideLoading() {
            document.body.classList.remove('loading');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('addDrillForm').addEventListener('submit', handleAddDrill);
            
            // Quick add form submission
            const quickAddForm = document.getElementById('quickAddForm');
            if (quickAddForm) {
                quickAddForm.addEventListener('submit', handleQuickAddDrill);
            }
            
            // Modal close on outside click
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            console.log('‚úÖ Event listeners setup complete');
        }
    </script>
</body>
</html>
